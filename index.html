<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2048 ゲーム</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #faf8ef, #f2e9dc);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      touch-action: none;
    }
    .game { text-align: center; }
    h1 { margin: 5px 0; font-size: 48px; color: #776e65; }
    .score-wrap { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
    .score-box {
      background: #bbada0; color: white; padding: 10px 18px;
      border-radius: 8px; font-size: 18px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-gap: 10px;
      background: #bbada0;
      padding: 10px;
      border-radius: 10px;
      position: relative;
    }
    .cell {
      width: 80px; height: 80px;
      background: #cdc1b4;
      border-radius: 6px;
      display: flex; justify-content: center; align-items: center;
      font-size: 32px; font-weight: bold; color: #776e65;
    }
    .cell[data-value="2"] { background: #eee4da; }
    .cell[data-value="4"] { background: #ede0c8; }
    .cell[data-value="8"] { background: #f2b179; color: #f9f6f2; }
    .cell[data-value="16"] { background: #f59563; color: #f9f6f2; }
    .cell[data-value="32"] { background: #f67c5f; color: #f9f6f2; }
    .cell[data-value="64"] { background: #f65e3b; color: #f9f6f2; }
    .cell[data-value="128"] { background: #edcf72; color: #f9f6f2; font-size: 26px; }
    .cell[data-value="256"] { background: #edcc61; color: #f9f6f2; font-size: 26px; }
    .cell[data-value="512"] { background: #edc850; color: #f9f6f2; font-size: 26px; }
    .cell[data-value="1024"] { background: #edc53f; color: #f9f6f2; font-size: 22px; }
    .cell[data-value="2048"] { background: #edc22e; color: #f9f6f2; font-size: 22px; }
    button {
      margin-top: 12px; padding: 8px 18px; font-size: 16px;
      border: none; border-radius: 6px; background: #8f7a66; color: white;
    }
    .overlay {
      position: absolute; inset: 0;
      background: rgba(238,228,218,0.85);
      display: none; justify-content: center; align-items: center;
      font-size: 28px; color: #776e65; border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="game">
    <h1>2048</h1>
    <div class="score-wrap">
      <div class="score-box">Score: <span id="score">0</span></div>
      <div class="score-box">Best: <span id="best">0</span></div>
    </div>
    <div class="grid" id="grid">
      <div class="overlay" id="gameOver">ゲームオーバー</div>
    </div>
    <button onclick="init()">リスタート</button>
    <p>矢印キー / スワイプで操作</p>
  </div>

<script>
const size = 4;
let board = [];
let score = 0;
let bestScore = localStorage.getItem('best2048')
  ? Number(localStorage.getItem('best2048')) : 0;

const grid = document.getElementById('grid');
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const gameOverEl = document.getElementById('gameOver');

function init() {
  board = Array(size * size).fill(0);
  score = 0;
  scoreEl.textContent = score;
  bestEl.textContent = bestScore;
  gameOverEl.style.display = 'none';
  addTile(); addTile();
  draw();
}

function addTile() {
  const empty = board.map((v,i)=>v===0?i:null).filter(v=>v!==null);
  if (!empty.length) return;
  const i = empty[Math.floor(Math.random()*empty.length)];
  board[i] = Math.random()<0.9?2:4;
}

function draw() {
  grid.querySelectorAll('.cell').forEach(c=>c.remove());
  board.forEach(v=>{
    const cell=document.createElement('div');
    cell.className='cell';
    if(v){cell.textContent=v;cell.dataset.value=v;}
    grid.appendChild(cell);
  });
  if(isGameOver()) gameOverEl.style.display='flex';
}

function slide(row) {
  row=row.filter(v=>v);
  for(let i=0;i<row.length-1;i++){
    if(row[i]===row[i+1]){
      row[i]*=2; score+=row[i]; row[i+1]=0;
    }
  }
  return row.filter(v=>v).concat(Array(size-row.filter(v=>v).length).fill(0));
}

function move(dir){
  const old=board.join();
  if(dir==='L')for(let r=0;r<size;r++)board.splice(r*size,size,...slide(board.slice(r*size,r*size+size)));
  if(dir==='R')for(let r=0;r<size;r++)board.splice(r*size,size,...slide(board.slice(r*size,r*size+size).reverse()).reverse());
  if(dir==='U')for(let c=0;c<size;c++){let col=[];for(let r=0;r<size;r++)col.push(board[r*size+c]);col=slide(col);for(let r=0;r<size;r++)board[r*size+c]=col[r];}
  if(dir==='D')for(let c=0;c<size;c++){let col=[];for(let r=size-1;r>=0;r--)col.push(board[r*size+c]);col=slide(col).reverse();for(let r=0;r<size;r++)board[r*size+c]=col[r];}

  if(old!==board.join()){
    addTile();
    if(score>bestScore){
      bestScore=score;
      localStorage.setItem('best2048',bestScore);
    }
    scoreEl.textContent=score;
    bestEl.textContent=bestScore;
    draw();
  }
}

function isGameOver(){
  if(board.includes(0)) return false;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const i=r*size+c;
    if(c<size-1 && board[i]===board[i+1]) return false;
    if(r<size-1 && board[i]===board[i+size]) return false;
  }
  return true;
}

document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft')move('L');
  if(e.key==='ArrowRight')move('R');
  if(e.key==='ArrowUp')move('U');
  if(e.key==='ArrowDown')move('D');
});

let sx,sy;
document.addEventListener('touchstart', e => {
  e.preventDefault();
  sx = e.touches[0].clientX;
  sy = e.touches[0].clientY;
}, { passive: false });

document.addEventListener('touchend', e => {
  e.preventDefault();
  const dx = e.changedTouches[0].clientX - sx;
  const dy = e.changedTouches[0].clientY - sy;
  if (Math.abs(dx) > Math.abs(dy)) move(dx > 0 ? 'R' : 'L');
  else move(dy > 0 ? 'D' : 'U');
}, { passive: false });

init();
</script>
</body>
</html>
